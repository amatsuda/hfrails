<%
  google_key='ABQIAAAAnfs7bKE82qgb3Zc2YyS-oBT2yXp_' + 
    'ZAY8_ufC3CFXhHIE1NvwkxSySz_REpPq-4WZA27OwgbtyR3VcA'
  read_only ||= nil
  item ||= nil
  lines ||= []
%>
<div id="map"
  align="right"
  style="border: 1px solid #979797;
		 min-width: 400px;
		 min-height: 400px;
		 height: 100%;
		 background-color: #FFFFFF;
		 border: 1px solid #999999;
		 padding: 10px;"></div>
<script
  src="http://maps.google.com/maps?file=api&v=2&key=<%= google_key %>"
  type="text/javascript"></script>
<script type="text/javascript">
  var map_location = new GLatLng(47, 97);
  var marker;
  var map;

  function createMarker(point, label, html, id) {
    var mark1 = new GMarker(point);
    mark1.enableDragging();
    mark1.bouncy = true;
    GEvent.addListener(mark1, "click",
      function() {
        map_location = mark1.getPoint();
        map.panTo(map_location);
        var link = "";
        if (id != "") {
          link = "<br/><a href='/incidents/" + id + "'>More...</a>";
        }
        mark1.openInfoWindowHtml("<div align='left'><strong>" + label + "</strong><br/>"
          + html + link + "</div>");
      }
    );
    return mark1;
  }
  
 function initialize() {
   if (GBrowserIsCompatible()) {
     map = new GMap2(document.getElementById("map"));
     map.setCenter(map_location, 16);
     map.setZoom(2);
     map.addControl(new GLargeMapControl());
     map.addControl(new GHierarchicalMapTypeControl());
     map.enableScrollWheelZoom();
     map.enableDoubleClickZoom();
     map.setMapType(G_HYBRID_MAP);
   }
 }  
  
 function textFor(element, tag) {
   return element.getElementsByTagName(tag)[0].firstChild.nodeValue;
 }

 function addPoints(points) {
   var totlat = 0.0;
   var totlon = 0.0;
   var avcount = 0;
   for (var i = 0; i < points.length; i++) {
     m = points[i];
     // obtain the attribues of each marker
     var lat = parseFloat(textFor(m, "latitude"));
     var lng = parseFloat(textFor(m, "longitude"));
     totlat = totlat + lat;
     totlon = totlon + lng;
     avcount = avcount + 1;
     var point = new GLatLng(lat,lng);
     var html = textFor(m, "description");
     var label = textFor(m, "title");
     // create the marker
     var id ="";
     if (points.length > 1) {
       id = textFor(m, "id");
     }
     var marker = createMarker(point,label,html, id);
     map.addOverlay(marker);
   }
   return new GLatLng(totlat / avcount, totlon / avcount);
 }

 function loadXml(url) {
   var request = GXmlHttp.create();
   request.open("GET", url, true);
   request.onreadystatechange = function() {
     if (request.readyState == 4) {
       var xmlDoc = GXml.parse(request.responseText);
       var points = new Array();
       points[0] = xmlDoc.documentElement;
       var multi = (points[0].getElementsByTagName("datum").length > 0);
       if (multi) {
         points=points[0].getElementsByTagName("datum");
       }
       center = addPoints(points);
       map.setCenter(center);
       if (multi) {
         map.setZoom(2);
       } else {
         map.setZoom(8);
       }
     }
   }
   request.send(null);
 }
 initialize();
</script>
<% if (lines != nil) -%>
  <script type="text/javascript">
	loadXml('<%= data -%>')
  </script>
<% end %>
